<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Detalii Produs</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .detail-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 500px; width: 100%; }
        h1 { margin-top: 0; color: #333; }
        .price-tag { font-size: 2em; color: #28a745; font-weight: bold; margin: 20px 0; }
        .info-row { margin: 10px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .action-area { margin-top: 30px; display: flex; gap: 10px; }
        input[type="number"] { padding: 10px; width: 60px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; text-align: center;}
        
        /* Butonul de Adaugare in Cos */
        button.cart-btn { flex: 1; background: #fd7e14; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        button.cart-btn:hover { background: #e36d0a; }
        /* Stil pentru buton dezactivat */
        button.cart-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        button.back-btn { background: transparent; border: 1px solid #aaa; color: #555; padding: 12px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="detail-card">
        <div id="loading">Se Ã®ncarcÄƒ detaliile...</div>
        
        <div id="content" style="display:none;">
            <h1 id="d_nume">Nume Produs</h1>
            <div class="info-row"><strong>ProducÄƒtor:</strong> <span id="d_prod">...</span></div>
            <div class="info-row"><strong>Èšara:</strong> <span id="d_tara">...</span></div>
            <div class="info-row"><strong>ExpirÄƒ la:</strong> <span id="d_exp">...</span></div>
            
            <div class="info-row">
                <strong>Stoc Disponibil:</strong> 
                <span id="d_stoc" style="color:blue; font-weight:bold">...</span> buc.
            </div>
            
            <div class="price-tag" id="d_pret">0.00 RON</div>

            <div class="action-area">
                <button class="back-btn" onclick="window.history.back()">ÃŽnapoi</button>
                <input type="number" id="cantitate" value="1" min="1">
                <button id="btnAdauga" class="cart-btn" onclick="adaugaInCos()">ðŸ›’ AdaugÄƒ Ã®n CoÈ™</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. VARIABILE GLOBALE ---
        const API = "http://localhost:8080/api";
        const urlParams = new URLSearchParams(window.location.search);
        const furnizareId = urlParams.get('id');
        const clientId = localStorage.getItem('clientId');

        let currentOffer = null; // Aici stocam datele de la server

        // Validare: Daca nu esti logat, te trimite la login
        if(!clientId) {
            alert("Trebuie sÄƒ fii logat!");
            window.location.href = "index.html";
        }

        // Pornire
        loadDetails();

        // --- 2. INCARCARE DATE ---
        async function loadDetails() {
            try {
                const res = await fetch(`${API}/furnizari/${furnizareId}`);
                if(!res.ok) throw new Error("Produsul nu a fost gÄƒsit!");
                
                currentOffer = await res.json();
                
                // Populare HTML
                document.getElementById('d_nume').innerText = currentOffer.produs.denumire;
                document.getElementById('d_prod').innerText = currentOffer.producator.denumire;
                document.getElementById('d_tara').innerText = currentOffer.producator.taraOrigine;
                document.getElementById('d_exp').innerText = currentOffer.produs.dataExpirare;
                document.getElementById('d_pret').innerText = currentOffer.pretAchizitie + " RON";
                
                // LOGICA STOC
                const stocElement = document.getElementById('d_stoc');
                const btn = document.getElementById('btnAdauga');
                const inputCantitate = document.getElementById('cantitate');
                
                // Stocul vine de la server. Daca e undefined, punem 0.
                const stocCurent = currentOffer.stoc !== undefined ? currentOffer.stoc : 0;
                stocElement.innerText = stocCurent;

                if (stocCurent <= 0) {
                    stocElement.innerText = "STOC EPUIZAT";
                    stocElement.style.color = "red";
                    btn.disabled = true;
                    btn.innerText = "Indisponibil";
                    inputCantitate.disabled = true;
                    inputCantitate.value = 0;
                } else {
                    inputCantitate.setAttribute("max", stocCurent);
                }

                // Afisare
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (e) { 
                document.getElementById('loading').innerText = "Eroare: " + e.message; 
            }
        }

        // --- 3. ADAUGARE IN COS ---
        function adaugaInCos() {
            const cantitateCeruta = parseInt(document.getElementById('cantitate').value);
            const stocDisponibil = currentOffer.stoc !== undefined ? currentOffer.stoc : 0;

            // Validare simpla
            if (isNaN(cantitateCeruta) || cantitateCeruta <= 0) {
                alert("Cantitatea trebuie sÄƒ fie minim 1.");
                return;
            }

            // Construim cheia specifica clientului
            const cartKey = 'shoppingCart_' + clientId;
            
            // Citim cosul existent
            let cos = JSON.parse(localStorage.getItem(cartKey)) || [];

            // Verificam daca produsul e deja in cos
            const indexExistent = cos.findIndex(item => item.furnizareId === currentOffer.id);

            if (indexExistent !== -1) {
                // --- UPDATE ---
                const cantitateInCos = cos[indexExistent].cantitate;
                
                if (cantitateInCos + cantitateCeruta > stocDisponibil) {
                    alert(`Nu poÈ›i adÄƒuga Ã®ncÄƒ ${cantitateCeruta} buc! \nAi deja ${cantitateInCos} Ã®n coÈ™, iar stocul total este ${stocDisponibil}.`);
                    return;
                }
                
                cos[indexExistent].cantitate += cantitateCeruta;
                alert("Cantitatea din coÈ™ a fost actualizatÄƒ!");

            } else {
                // --- INSERT ---
                if (cantitateCeruta > stocDisponibil) {
                    alert(`Nu poÈ›i adÄƒuga mai mult decÃ¢t stocul disponibil (${stocDisponibil}).`);
                    document.getElementById('cantitate').value = stocDisponibil;
                    return;
                }

                const itemCos = {
                    furnizareId: currentOffer.id,
                    produsId: currentOffer.produs.id,
                    nume: currentOffer.produs.denumire,
                    producator: currentOffer.producator.denumire,
                    pret: currentOffer.pretAchizitie,
                    cantitate: cantitateCeruta,
                    stocMax: stocDisponibil // Salvam stocul maxim pentru validari ulterioare in cos
                };

                cos.push(itemCos);
                alert("Produs adÄƒugat Ã®n coÈ™!");
            }

            // Salvam inapoi
            localStorage.setItem(cartKey, JSON.stringify(cos));

            // Redirect
            window.location.href = "dashboard_client.html";
        }
    </script>
</body>
</html>